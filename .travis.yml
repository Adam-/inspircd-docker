sudo: required
language: bash
services:
  - docker

before_install:
  - sudo apt-get -qq update
  - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-engine
  - sudo apt-get install -y openssl parallel


script:
  # Create swarm for explicit testing
  # Make sure that there is a useable ip address as "advertise address" because else the swarm creation fails maybe
  - docker swarm init --advertise-addr `ip addr s | grep global | grep -oE '((1?[0-9][0-9]?|2[0-4][0-9]|25[0-5])\.){3}(1?[0-9][0-9]?|2[0-4][0-9]|25[0-5])' | head -n1`
  # Initial build with default parameters
  - docker build -t inspircd:testing .
  # Run all tests from test directory
  - ls tests/*.sh | parallel --joblog /tmp/joblog
  - cat /tmp/joblog
after_success:
  # Run build on Docker Hub
  # For own builds add DOCKER_PUSH_URL as environment variable
  # See https://docs.travis-ci.com/user/environment-variables/#Defining-Variables-in-Repository-Settings
  - '[ "$TRAVIS_EVENT_TYPE" = "cron" ] &&  [ "$TRAVIS_PULL_REQUEST" = "false" ] && [ "$TRAVIS_BRANCH" = "master" ] && [ "$DOCKER_PUSH_URL" != "" ]  && curl --data build=true -X POST $DOCKER_PUSH_URL'

